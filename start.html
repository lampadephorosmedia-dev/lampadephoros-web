<!-- FILE: start.html (FINAL – Cloudflare Pages Clean Routes + lamp_lang + DE fallback) -->
<!doctype html>
<html lang="de" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lampadēphóros – Start</title>
  <meta name="description" content="Lampadēphóros – Der Fackelträger. Multilinguale Startseite." />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <main class="wrap">

    <header class="hero">
      <!-- Sprache (automatisch) -->
      <div class="lang" aria-label="Sprachauswahl" data-current="de"></div>

      <!-- Brand -->
      <div class="brand">
        <img class="logo" src="logo.png" alt="Lampadēphóros Logo" />
        <div class="brand-meta">
          <div class="badge">Lampadēphóros</div>
          <div class="mini" id="brandMini">Der Fackelträger</div>
        </div>
      </div>

      <h1 id="heroTitle">Lampadēphóros</h1>
      <p class="sub" id="heroSub"></p>

      <nav class="nav" aria-label="Navigation">
        <!-- Clean Routes -->
        <a class="btn primary" id="navStart" href="/start"></a>
        <a class="btn" id="navAbout" href="/about"></a>
        <a class="btn" id="navFilms" href="/filme"></a>
        <a class="btn" id="navImpulses" href="/impulse"></a>
        <a class="btn" id="navWorkshop" href="/werkstatt"></a>
        <a class="btn" id="navOffers" href="/angebote"></a>
        <a class="btn" id="navShop" href="/shop"></a>
        <a class="btn" id="navLinks" href="/links"></a>
      </nav>

      <div class="note" id="noteLine"></div>
    </header>

    <section class="grid" aria-label="Übersicht">
      <article class="card">
        <h2 id="cAboutH"></h2>
        <p id="cAboutP"></p>
        <a id="cAboutA" href="/about"></a>
      </article>

      <article class="card">
        <h2 id="cFilmsH"></h2>
        <p id="cFilmsP"></p>
        <a id="cFilmsA" href="/filme"></a>
      </article>

      <article class="card">
        <h2 id="cImpH"></h2>
        <p id="cImpP"></p>
        <a id="cImpA" href="/impulse"></a>
      </article>

      <article class="card">
        <h2 id="cWorkH"></h2>
        <p id="cWorkP"></p>
        <a id="cWorkA" href="/werkstatt"></a>
      </article>

      <article class="card">
        <h2 id="cOffersH"></h2>
        <p id="cOffersP"></p>
        <a id="cOffersA" href="/angebote"></a>
      </article>

      <article class="card">
        <h2 id="cShopH"></h2>
        <p id="cShopP"></p>
        <a id="cShopA" href="/shop"></a>
      </article>
    </section>

    <footer class="footer">
      <div class="visitor-pill" aria-label="Besucherzähler">
        <span class="label" id="vVisitors"></span>
        <span id="countPage" class="count">—</span>
        <span class="sep">•</span>
        <span class="label" id="vTotal"></span>
        <span id="countTotal" class="count">—</span>
      </div>

      <div class="footer-line">
        © Lampadēphóros • <span id="fContact"></span>
        <a href="mailto:lampadephoros.media@gmail.com">lampadephoros.media@gmail.com</a>
      </div>
    </footer>

  </main>

  <!-- Deine bestehenden Dateien -->
  <script src="langs.js"></script>
  <script src="start-i18n.js"></script>
  <script src="lang-menu.js"></script>

  <script>
  (function () {
    const STORAGE_KEY = "lamp_lang";

    const norm = (x) => (x || "").toString().trim().toLowerCase();
    const base = (tag) => String(tag || "").toLowerCase().split("-")[0];

    const qs = new URLSearchParams(location.search);
    const urlLang = norm(qs.get("lang"));

    // Supported: bevorzugt LANGS.js, sonst START_I18N keys, sonst "de"
    const supported = new Set();
    (window.LANGS || []).forEach(x => x?.code && supported.add(norm(x.code)));
    Object.keys(window.START_I18N || {}).forEach(k => supported.add(norm(k)));
    if (!supported.size) supported.add("de");

    const browserPrefs = (navigator.languages && navigator.languages.length)
      ? navigator.languages
      : [navigator.language || "de"];

    // Resolve language (URL > storage > legacy > browser > de)
    let lang = "de";

    if (supported.has(urlLang)) {
      lang = urlLang;
    } else {
      const saved = norm(localStorage.getItem(STORAGE_KEY));
      const legacy = norm(localStorage.getItem("lp_lang"));
      if (supported.has(saved)) {
        lang = saved;
      } else if (supported.has(legacy)) {
        lang = legacy;
      } else {
        for (const t of browserPrefs) {
          const b = base(t);
          if (supported.has(b)) { lang = b; break; }
        }
      }
    }

    // Persist
    try { localStorage.setItem(STORAGE_KEY, lang); } catch(e){}
    try { localStorage.setItem("lp_lang", lang); } catch(e){} // optional legacy

    // Direction
    const curObj = (window.LANGS || []).find(x => norm(x.code) === lang);
    const dir = curObj?.dir || "ltr";
    document.documentElement.setAttribute("dir", dir);
    document.documentElement.setAttribute("lang", lang);

    // Set current for menu
    const holder = document.querySelector(".lang[data-current]");
    if (holder) holder.setAttribute("data-current", lang);

    // Render menu (falls vorhanden)
    if (typeof window.renderLangMenu === "function") window.renderLangMenu();

    // Helper: keep lang on internal links (and UPDATE if already present)
    const withLang = (href) => {
      if (!href) return href;
      if (href.startsWith("#")) return href;
      if (/^(https?:)?\/\//i.test(href) || href.startsWith("mailto:") || href.startsWith("tel:")) return href;

      const u = new URL(href, location.origin);
      u.searchParams.set("lang", lang);
      const q = u.searchParams.toString();
      return u.pathname + (q ? `?${q}` : "") + u.hash;
    };

    // Texts (NO EN fallback — fallback is DE)
    const dictAll = window.START_I18N || {};
    const dict = dictAll[lang] || dictAll["de"] || {};

    document.getElementById("brandMini").textContent = (dict.brandMini || "Der Fackelträger");

    document.getElementById("heroTitle").textContent = (dict.title || "Lampadēphóros");
    document.getElementById("heroSub").textContent   = (dict.sub   || "");
    document.getElementById("noteLine").textContent  = (dict.note  || "");

    const nav = dict.nav || {};
    document.getElementById("navStart").textContent     = (nav.start     || "Start");
    document.getElementById("navAbout").textContent     = (nav.about     || "Über uns");
    document.getElementById("navFilms").textContent     = (nav.films     || "Filme & Kapitel");
    document.getElementById("navImpulses").textContent  = (nav.impulses  || "Impulse");
    document.getElementById("navWorkshop").textContent  = (nav.workshop  || "Werkstatt");
    document.getElementById("navOffers").textContent    = (nav.offers    || "Angebote");
    document.getElementById("navShop").textContent      = (nav.shop      || "Shop");
    document.getElementById("navLinks").textContent     = (nav.links     || "Hier findest du uns");

    const c = dict.cards || {};
    const setCard = (key, hId, pId, aId) => {
      document.getElementById(hId).textContent = c[key]?.h || "";
      document.getElementById(pId).textContent = c[key]?.p || "";
      document.getElementById(aId).textContent = c[key]?.a || "";
    };
    setCard("about",    "cAboutH",  "cAboutP",  "cAboutA");
    setCard("films",    "cFilmsH",  "cFilmsP",  "cFilmsA");
    setCard("impulses", "cImpH",    "cImpP",    "cImpA");
    setCard("workshop", "cWorkH",   "cWorkP",   "cWorkA");
    setCard("offers",   "cOffersH", "cOffersP", "cOffersA");
    setCard("shop",     "cShopH",   "cShopP",   "cShopA");

    const f = dict.footer || {};
    document.getElementById("fContact").textContent = (f.contact || "Kontakt:");
    document.getElementById("vVisitors").textContent = (f.visitors || "Besucher");
    document.getElementById("vTotal").textContent = (f.total || "Gesamt");

    // Ensure ALL internal links keep lang
    document.querySelectorAll('a[href]').forEach(a => {
      a.setAttribute("href", withLang(a.getAttribute("href")));
    });

    // Counter
    (async () => {
      const NS = "lampadephoros_web";
      const PAGE = `start_${lang}`;
      const TOTAL = "start_total";

      const urlPage  = `https://api.counterapi.dev/v1/${NS}/${PAGE}/up`;
      const urlTotal = `https://api.counterapi.dev/v1/${NS}/${TOTAL}/up`;

      const [pageData, totalData] = await Promise.all([
        fetch(urlPage,  { cache: "no-store" }).then(r => r.json()),
        fetch(urlTotal, { cache: "no-store" }).then(r => r.json())
      ]);

      const pickCount = (obj) => (obj && (obj.count ?? obj.value ?? obj.total ?? obj.result ?? obj.data?.count)) ?? "—";
      document.getElementById("countPage").textContent  = pickCount(pageData);
      document.getElementById("countTotal").textContent = pickCount(totalData);
    })().catch(() => {
      const a = document.getElementById("countPage");
      const b = document.getElementById("countTotal");
      if (a) a.textContent = "—";
      if (b) b.textContent = "—";
    });

  })();
  </script>
</body>
</html>
