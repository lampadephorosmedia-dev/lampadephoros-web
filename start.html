<!-- FILE: start.html (FINAL) -->
<!doctype html>
<html lang="de" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lampadēphóros – Start</title>
  <meta name="description" content="Lampadēphóros – Der Fackelträger. Multilinguale Startseite." />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <main class="wrap">

    <header class="hero">
      <!-- Sprache (automatisch) -->
      <div class="lang" aria-label="Sprachauswahl" data-current="de"></div>

      <!-- Brand -->
      <div class="brand">
        <img class="logo" src="logo.png" alt="Lampadēphóros Logo" />
        <div class="brand-meta">
          <div class="badge">Lampadēphóros</div>
          <div class="mini">Der Fackelträger</div>
        </div>
      </div>

      <h1 id="heroTitle">Lampadēphóros</h1>
      <p class="sub" id="heroSub"></p>

      <nav class="nav" aria-label="Navigation">
        <!-- Clean routes -->
        <a class="btn primary" id="navStart" href="/start"></a>
        <a class="btn" id="navAbout" href="about.html"></a>
        <a class="btn" id="navFilms" href="/filme"></a>
        <a class="btn" id="navImpulses" href="impulse.html"></a>
        <a class="btn" id="navWorkshop" href="werkstatt.html"></a>
        <a class="btn" id="navOffers" href="angebote.html"></a>
        <a class="btn" id="navShop" href="shop.html"></a>
        <a class="btn" id="navLinks" href="links.html"></a>
      </nav>

      <div class="note" id="noteLine"></div>
    </header>

    <section class="grid" aria-label="Übersicht">
      <article class="card">
        <h2 id="cAboutH"></h2>
        <p id="cAboutP"></p>
        <a id="cAboutA" href="about.html"></a>
      </article>

      <article class="card">
        <h2 id="cFilmsH"></h2>
        <p id="cFilmsP"></p>
        <a id="cFilmsA" href="/filme"></a>
      </article>

      <article class="card">
        <h2 id="cImpH"></h2>
        <p id="cImpP"></p>
        <a id="cImpA" href="impulse.html"></a>
      </article>

      <article class="card">
        <h2 id="cWorkH"></h2>
        <p id="cWorkP"></p>
        <a id="cWorkA" href="werkstatt.html"></a>
      </article>

      <article class="card">
        <h2 id="cOffersH"></h2>
        <p id="cOffersP"></p>
        <a id="cOffersA" href="angebote.html"></a>
      </article>

      <article class="card">
        <h2 id="cShopH"></h2>
        <p id="cShopP"></p>
        <a id="cShopA" href="shop.html"></a>
      </article>
    </section>

    <footer class="footer">
      <div class="visitor-pill" aria-label="Besucherzähler">
        <span class="label" id="vVisitors"></span>
        <span id="countPage" class="count">—</span>
        <span class="sep">•</span>
        <span class="label" id="vTotal"></span>
        <span id="countTotal" class="count">—</span>
      </div>

      <div class="footer-line">
        © Lampadēphóros • <span id="fContact"></span>
        <a href="mailto:lampadephoros.media@gmail.com">lampadephoros.media@gmail.com</a>
      </div>
    </footer>

  </main>

  <script src="langs.js"></script>
  <script src="start-i18n.js"></script>
  <script src="lang-menu.js"></script>

  <script>
  (function () {
    "use strict";

    const STORAGE_KEY = "lamp_lang";

    const base = (tag) => String(tag || "").toLowerCase().split("-")[0];
    const norm = (x) => String(x || "").trim().toLowerCase();

    // Supported langs come from langs.js
    const supported = new Set((window.LANGS || []).map(x => x.code));

    // URL lang
    const qs = new URLSearchParams(location.search);
    const urlLang = base(qs.get("lang"));

    // browser prefs
    const browserPrefs = (navigator.languages && navigator.languages.length)
      ? navigator.languages
      : [navigator.language || "de"];

    // Decide active lang: URL -> storage -> browser -> de
    let lang = "de";

    if (urlLang && supported.has(urlLang)) {
      lang = urlLang;
    } else {
      const saved = base(localStorage.getItem(STORAGE_KEY));
      if (saved && supported.has(saved)) {
        lang = saved;
      } else {
        for (const t of browserPrefs) {
          const b = base(t);
          if (supported.has(b)) { lang = b; break; }
        }
      }
    }

    // Persist only ONE key
    try { localStorage.setItem(STORAGE_KEY, lang); } catch(e){}

    // Ensure URL has lang param (nice & consistent)
    try {
      const u = new URL(location.href);
      if (base(u.searchParams.get("lang")) !== lang) {
        u.searchParams.set("lang", lang);
        history.replaceState({}, "", u.toString());
      }
    } catch(e){}

    // document direction
    const curObj = (window.LANGS || []).find(x => x.code === lang);
    const dir = curObj?.dir || "ltr";
    document.documentElement.setAttribute("dir", dir);
    document.documentElement.setAttribute("lang", lang);

    // set current
    const holder = document.querySelector(".lang[data-current]");
    if (holder) holder.setAttribute("data-current", lang);

    // render menu (existing function)
    if (typeof window.renderLangMenu === "function") window.renderLangMenu();

    // Helper: keep lang param on internal links (robust, no duplicates)
    const withLang = (href) => {
      if (!href) return href;
      if (href.startsWith("#")) return href;
      if (/^https?:\/\//i.test(href) || href.startsWith("mailto:")) return href;
      try {
        const u = new URL(href, location.origin);
        u.searchParams.set("lang", lang);
        return u.pathname + "?" + u.searchParams.toString();
      } catch {
        // fallback minimal
        const sep = href.includes("?") ? "&" : "?";
        return href + sep + "lang=" + encodeURIComponent(lang);
      }
    };

    // Apply lang to ALL internal anchors (so you don’t miss any)
    document.querySelectorAll("a[href]").forEach(a => {
      const href = a.getAttribute("href") || "";
      a.setAttribute("href", withLang(href));
    });

    // Texts (DE fallback only)
    const dictAll = window.START_I18N || {};
    const dict = dictAll[lang] || dictAll["de"] || {};

    const nav = dict.nav || {};
    const deNav = (dictAll["de"] || {}).nav || {};

    const txt = (v, fallback) => (v != null && v !== "") ? v : fallback;

    document.getElementById("heroTitle").textContent = txt(dict.title, "Lampadēphóros");
    document.getElementById("heroSub").textContent   = txt(dict.sub, "");
    document.getElementById("noteLine").textContent  = txt(dict.note, "");

    // IMPORTANT: no EN fallbacks here; if missing -> DE
    document.getElementById("navStart").textContent    = txt(nav.start,    deNav.start    || "Start");
    document.getElementById("navAbout").textContent    = txt(nav.about,    deNav.about    || "Über uns");
    document.getElementById("navFilms").textContent    = txt(nav.films,    deNav.films    || "Filme");
    document.getElementById("navImpulses").textContent = txt(nav.impulses, deNav.impulses || "Impulse");
    document.getElementById("navWorkshop").textContent = txt(nav.workshop, deNav.workshop || "Werkstatt");
    document.getElementById("navOffers").textContent   = txt(nav.offers,   deNav.offers   || "Angebote");
    document.getElementById("navShop").textContent     = txt(nav.shop,     deNav.shop     || "Shop");
    document.getElementById("navLinks").textContent    = txt(nav.links,    deNav.links    || "Hier findest du uns");

    const c = dict.cards || {};
    const deC = (dictAll["de"] || {}).cards || {};
    const setCard = (key, hId, pId, aId) => {
      const ch = c[key]?.h ?? deC[key]?.h ?? "";
      const cp = c[key]?.p ?? deC[key]?.p ?? "";
      const ca = c[key]?.a ?? deC[key]?.a ?? "";
      document.getElementById(hId).textContent = ch;
      document.getElementById(pId).textContent = cp;
      document.getElementById(aId).textContent = ca;
    };
    setCard("about",    "cAboutH",  "cAboutP",  "cAboutA");
    setCard("films",    "cFilmsH",  "cFilmsP",  "cFilmsA");
    setCard("impulses", "cImpH",    "cImpP",    "cImpA");
    setCard("workshop", "cWorkH",   "cWorkP",   "cWorkA");
    setCard("offers",   "cOffersH", "cOffersP", "cOffersA");
    setCard("shop",     "cShopH",   "cShopP",   "cShopA");

    const f = dict.footer || {};
    const deF = (dictAll["de"] || {}).footer || {};
    document.getElementById("fContact").textContent  = txt(f.contact,  deF.contact  || "Kontakt:");
    document.getElementById("vVisitors").textContent = txt(f.visitors, deF.visitors || "Besucher");
    document.getElementById("vTotal").textContent    = txt(f.total,    deF.total    || "Gesamt");

    // counter
    (async () => {
      const NS = "lampadephoros_web";
      const PAGE = `start_${lang}`;
      const TOTAL = "start_total";

      const urlPage  = `https://api.counterapi.dev/v1/${NS}/${PAGE}/up`;
      const urlTotal = `https://api.counterapi.dev/v1/${NS}/${TOTAL}/up`;

      const [pageData, totalData] = await Promise.all([
        fetch(urlPage,  { cache: "no-store" }).then(r => r.json()),
        fetch(urlTotal, { cache: "no-store" }).then(r => r.json())
      ]);

      const pick = (obj) => (obj && (obj.count ?? obj.value ?? obj.total ?? obj.result ?? obj.data?.count)) ?? "—";
      document.getElementById("countPage").textContent  = pick(pageData);
      document.getElementById("countTotal").textContent = pick(totalData);
    })().catch(() => {
      const a = document.getElementById("countPage");
      const b = document.getElementById("countTotal");
      if (a) a.textContent = "—";
      if (b) b.textContent = "—";
    });
  })();
  </script>
</body>
</html>
